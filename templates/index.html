<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Cron√¥metro Inteligente</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 20px;
      }

      .container {
        max-width: 600px;
        margin: 0 auto;
        background: white;
        border-radius: 15px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        overflow: hidden;
      }

      .header {
        background: linear-gradient(135deg, #2c3e50, #34495e);
        color: white;
        padding: 30px;
        text-align: center;
      }

      .header h1 {
        font-size: 2.5em;
        margin-bottom: 10px;
      }

      .controls {
        padding: 30px;
      }

      .form-group {
        margin-bottom: 20px;
      }

      label {
        display: block;
        margin-bottom: 5px;
        font-weight: 600;
        color: #2c3e50;
      }

      input {
        width: 100%;
        padding: 12px;
        border: 2px solid #e9ecef;
        border-radius: 8px;
        font-size: 16px;
        transition: border-color 0.3s;
      }

      input:focus {
        outline: none;
        border-color: #667eea;
      }

      .row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 15px;
      }

      .button-group {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 15px;
        margin-top: 30px;
      }

      button {
        padding: 15px;
        border: none;
        border-radius: 8px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
      }

      .btn-primary {
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: white;
      }

      .btn-secondary {
        background: #6c757d;
        color: white;
      }

      .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
      }

      .btn-secondary:hover {
        background: #5a6268;
      }

      .btn-danger {
        background: #dc3545;
        color: white;
      }

      .btn-danger:hover {
        background: #c82333;
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
      }

      .timer-display {
        background: #2c3e50;
        color: white;
        padding: 40px;
        border-radius: 10px;
        text-align: center;
        margin-top: 20px;
        display: none;
      }

      .timer-display.active {
        display: block;
      }

      .countdown-display {
        background: linear-gradient(135deg, #ff6b6b, #ee5a24);
        color: white;
        padding: 40px;
        border-radius: 10px;
        text-align: center;
        margin-top: 20px;
        display: none;
      }

      .countdown-display.active {
        display: block;
        animation: pulse 1s infinite;
      }

      .rest-display {
        background: linear-gradient(135deg, #fdcb6e, #e17055);
        color: #2d3436;
        padding: 40px;
        border-radius: 10px;
        text-align: center;
        margin-top: 20px;
        display: none;
      }

      .rest-display.active {
        display: block;
      }

      @keyframes pulse {
        0% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.05);
        }
        100% {
          transform: scale(1);
        }
      }

      .time-numbers {
        font-size: 4em;
        font-weight: bold;
        font-family: "Courier New", monospace;
        margin: 20px 0;
      }

      .countdown-numbers {
        font-size: 5em;
        font-weight: bold;
        font-family: "Courier New", monospace;
        margin: 20px 0;
      }

      .phase-indicator {
        font-size: 1.5em;
        font-weight: bold;
        margin: 15px 0;
        padding: 10px;
        border-radius: 8px;
      }

      .phase-work {
        background: #00b894;
        color: white;
      }

      .phase-rest {
        background: #fdcb6e;
        color: #2d3436;
      }

      .phase-countdown {
        background: #e17055;
        color: white;
      }

      .timer-info {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 15px;
        margin-top: 15px;
      }

      .info-card {
        background: rgba(255, 255, 255, 0.1);
        padding: 15px;
        border-radius: 8px;
        text-align: center;
      }

      .info-card h4 {
        margin-bottom: 5px;
        font-size: 0.9em;
        opacity: 0.8;
      }

      .info-card .value {
        font-size: 1.3em;
        font-weight: bold;
      }

      .progress-bar {
        width: 100%;
        height: 20px;
        background: #34495e;
        border-radius: 10px;
        overflow: hidden;
        margin: 20px 0;
      }

      .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, #00b09b, #96c93d);
        transition: width 0.5s ease;
      }

      .stop-section {
        text-align: center;
        margin-top: 20px;
        padding: 20px;
        background: #f8d7da;
        border-radius: 8px;
        display: none;
      }

      .stop-section.active {
        display: block;
      }

      .status-message {
        text-align: center;
        padding: 15px;
        margin-top: 15px;
        border-radius: 8px;
        display: none;
      }

      .status-success {
        background: #d4edda;
        color: #155724;
        display: block;
      }

      .status-error {
        background: #f8d7da;
        color: #721c24;
        display: block;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>‚è∞ Cron√¥metro Inteligente</h1>
        <p>Controle seu tempo de forma eficiente</p>
      </div>

      <div class="controls">
        <div class="form-group">
          <label for="totalTime">Tempo Total (minutos):</label>
          <input
            type="number"
            id="totalTime"
            placeholder="Ex: 15"
            min="1"
            value="2"
          />
        </div>

        <div class="form-group">
          <label for="interval">Intervalo para Sinal Sonoro (minutos):</label>
          <input
            type="number"
            id="interval"
            placeholder="Ex: 5 (0 para desativar)"
            min="0"
            value="1"
          />
        </div>

        <div class="row">
          <div class="form-group">
            <label for="rounds">N√∫mero de Rounds:</label>
            <input
              type="number"
              id="rounds"
              placeholder="Ex: 3"
              min="1"
              value="3"
            />
          </div>
          <div class="form-group">
            <label for="restTime">Tempo de Descanso (segundos):</label>
            <input
              type="number"
              id="restTime"
              placeholder="Ex: 30 segundos"
              min="0"
              value="10"
            />
          </div>
        </div>

        <div
          class="info-card"
          style="background: #e3f2fd; color: #1565c0; margin: 15px 0"
        >
          <h4>üìù Configura√ß√£o Atual</h4>
          <div id="configSummary">3 rounds de 40 segundos cada</div>
        </div>

        <div class="button-group">
          <button class="btn-primary" onclick="startTimer()">
            ‚ñ∂ Iniciar Timer
          </button>
          <button class="btn-secondary" onclick="resetForm()">üîÑ Limpar</button>
        </div>

        <!-- Display da Contagem Regressiva (Prepara√ß√£o) -->
        <div class="countdown-display" id="countdownDisplay">
          <h3>üéØ Preparando para o Round</h3>
          <div class="countdown-numbers" id="countdownNumbers">10</div>
          <div class="phase-indicator phase-countdown">
            Round <span id="nextRoundNumber">1</span> come√ßando em...
          </div>
        </div>

        <!-- Display do Descanso -->
        <div class="rest-display" id="restDisplay">
          <h3>‚òï Tempo de Descanso</h3>
          <div class="countdown-numbers" id="restNumbers">10</div>
          <div class="phase-indicator phase-rest">
            Round <span id="restRoundNumber">1</span> finalizado
          </div>
          <p>Pr√≥ximo round em...</p>
        </div>

        <!-- Display do Cron√¥metro Ativo -->
        <div class="timer-display" id="timerDisplay">
          <div class="phase-indicator" id="phaseIndicator">Trabalho</div>
          <div class="time-numbers" id="timeDisplay">00:00</div>

          <div class="progress-bar">
            <div
              class="progress-fill"
              id="roundProgressFill"
              style="width: 0%"
            ></div>
          </div>

          <div class="timer-info">
            <div class="info-card">
              <h4>Round</h4>
              <div class="value" id="currentRound">1/3</div>
            </div>
            <div class="info-card">
              <h4>Tempo do Round</h4>
              <div class="value" id="roundTime">00:00</div>
            </div>
          </div>

          <div class="timer-info">
            <div class="info-card">
              <h4>Progresso do Round</h4>
              <div class="value" id="roundProgress">0%</div>
            </div>
            <div class="info-card">
              <h4>Progresso Total</h4>
              <div class="value" id="totalProgress">0%</div>
            </div>
          </div>
        </div>

        <!-- Se√ß√£o de Parada -->
        <div class="stop-section" id="stopSection">
          <h3>‚èπÔ∏è Timer Ativo</h3>
          <p>
            Um cron√¥metro est√° em execu√ß√£o. Use o bot√£o abaixo para par√°-lo.
          </p>
          <button class="btn-danger" onclick="stopTimer()">
            ‚èπ Parar Timer
          </button>
        </div>

        <!-- Mensagem de Status -->
        <div class="status-message" id="statusMessage"></div>
      </div>
    </div>

    <script>
      let currentTimerId = null;
      let statusInterval = null;

      // Formatador de tempo (segundos para MM:SS)
      function formatTime(seconds) {
        const mins = Math.floor(seconds / 60);
        const secs = Math.floor(seconds % 60);
        return `${mins.toString().padStart(2, "0")}:${secs
          .toString()
          .padStart(2, "0")}`;
      }

      // Atualizar resumo da configura√ß√£o
      function updateConfigSummary() {
        const totalTime =
          parseInt(document.getElementById("totalTime").value) || 0;
        const rounds = parseInt(document.getElementById("rounds").value) || 1;
        const roundDuration = (totalTime * 60) / rounds;

        if (totalTime > 0 && rounds > 0) {
          const summary = `${rounds} rounds de ${formatTime(
            roundDuration
          )} cada`;
          document.getElementById("configSummary").textContent = summary;
        }
      }

      // Mostrar mensagem de status
      function showStatus(message, type = "success") {
        const statusElement = document.getElementById("statusMessage");
        statusElement.textContent = message;
        statusElement.className = `status-message status-${type}`;
        setTimeout(() => {
          statusElement.style.display = "none";
        }, 3000);
      }

      // Resetar formul√°rio
      function resetForm() {
        document.getElementById("totalTime").value = "2";
        document.getElementById("interval").value = "1";
        document.getElementById("rounds").value = "3";
        document.getElementById("restTime").value = "10";
        updateConfigSummary();
        hideAllDisplays();
        showStatus("Formul√°rio limpo");
      }

      // Atualizar display do cron√¥metro
      function updateTimerDisplay() {
        if (!currentTimerId) {
          hideAllDisplays();
          return;
        }

        fetch(`/timer_status/${currentTimerId}`)
          .then((response) => {
            if (!response.ok) {
              throw new Error("Timer n√£o encontrado");
            }
            return response.json();
          })
          .then((data) => {
            // Verificar se o timer foi parado
            if (!data.is_running) {
              stopTimerDisplay();
              showStatus("Timer finalizado", "success");
              return;
            }

            // Contagem regressiva (prepara√ß√£o antes do round)
            if (data.is_countdown && data.current_phase === "countdown") {
              showCountdownDisplay(data);
              return;
            }

            // Fase de descanso
            if (data.current_phase === "rest") {
              showRestDisplay(data);
              return;
            }

            // Fase de trabalho (contagem progressiva)
            if (data.current_phase === "work") {
              showWorkDisplay(data);
              return;
            }
          })
          .catch((error) => {
            console.log("Timer finalizado ou n√£o encontrado:", error);
            stopTimerDisplay();
          });
      }

      function showCountdownDisplay(data) {
        document.getElementById("countdownDisplay").classList.add("active");
        document.getElementById("restDisplay").classList.remove("active");
        document.getElementById("timerDisplay").classList.remove("active");
        document.getElementById("stopSection").classList.add("active");

        document.getElementById("countdownNumbers").textContent =
          data.countdown_seconds;
        document.getElementById("nextRoundNumber").textContent =
          data.current_round;
      }

      function showRestDisplay(data) {
        document.getElementById("countdownDisplay").classList.remove("active");
        document.getElementById("restDisplay").classList.add("active");
        document.getElementById("timerDisplay").classList.remove("active");
        document.getElementById("stopSection").classList.add("active");

        document.getElementById("restNumbers").textContent =
          data.countdown_seconds;
        document.getElementById("restRoundNumber").textContent =
          data.current_round - 1;
      }

      function showWorkDisplay(data) {
        document.getElementById("countdownDisplay").classList.remove("active");
        document.getElementById("restDisplay").classList.remove("active");
        document.getElementById("timerDisplay").classList.add("active");
        document.getElementById("stopSection").classList.add("active");

        const timeDisplay = document.getElementById("timeDisplay");
        const phaseIndicator = document.getElementById("phaseIndicator");
        const currentRound = document.getElementById("currentRound");
        const roundTime = document.getElementById("roundTime");
        const roundProgress = document.getElementById("roundProgress");
        const totalProgress = document.getElementById("totalProgress");
        const roundProgressFill = document.getElementById("roundProgressFill");

        // Atualizar informa√ß√µes do round
        phaseIndicator.className = "phase-indicator phase-work";
        phaseIndicator.textContent = `üéØ Round ${data.current_round} - Trabalho`;

        timeDisplay.textContent = formatTime(data.round_elapsed);
        roundTime.textContent = `${formatTime(
          data.round_elapsed
        )} / ${formatTime(data.round_duration)}`;
        currentRound.textContent = `${data.current_round}/${data.total_rounds}`;

        // Atualizar barras de progresso
        const roundProgressPercent = data.round_progress || 0;
        const totalProgressPercent = data.progress || 0;

        roundProgressFill.style.width = `${roundProgressPercent}%`;
        roundProgress.textContent = `${Math.round(roundProgressPercent)}%`;
        totalProgress.textContent = `${Math.round(totalProgressPercent)}%`;
      }

      function hideAllDisplays() {
        document.getElementById("timerDisplay").classList.remove("active");
        document.getElementById("countdownDisplay").classList.remove("active");
        document.getElementById("restDisplay").classList.remove("active");
        document.getElementById("stopSection").classList.remove("active");
      }

      // Parar display do cron√¥metro
      function stopTimerDisplay() {
        if (statusInterval) {
          clearInterval(statusInterval);
          statusInterval = null;
        }
        hideAllDisplays();
        currentTimerId = null;
      }

      // Iniciar timer
      function startTimer() {
        const totalTime = parseInt(document.getElementById("totalTime").value);
        const interval =
          parseInt(document.getElementById("interval").value) || 0;
        const rounds = parseInt(document.getElementById("rounds").value) || 1;
        const restTime =
          parseInt(document.getElementById("restTime").value) || 0;

        if (!totalTime || totalTime <= 0) {
          alert("Por favor, informe um tempo total v√°lido!");
          return;
        }

        if (!rounds || rounds <= 0) {
          alert("Por favor, informe um n√∫mero de rounds v√°lido!");
          return;
        }

        const roundDuration = (totalTime * 60) / rounds;
        if (roundDuration <= 0) {
          alert("O tempo por round deve ser maior que 0!");
          return;
        }

        const data = {
          total_time: totalTime,
          interval: interval,
          rounds: rounds,
          rest_time: restTime,
        };

        fetch("/start_timer", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify(data),
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.error) {
              alert(data.error);
              return;
            }

            currentTimerId = data.timer_id;
            showStatus(`Timer ${data.timer_id} iniciado com sucesso`);

            // Iniciar atualiza√ß√£o do display do cron√¥metro
            if (statusInterval) {
              clearInterval(statusInterval);
            }
            statusInterval = setInterval(updateTimerDisplay, 100);
            updateTimerDisplay(); // Chamada inicial
          })
          .catch((error) => {
            console.error("Erro:", error);
            alert("Erro ao iniciar timer");
          });
      }

      // Parar timer
      function stopTimer() {
        if (!currentTimerId) {
          alert("Nenhum timer ativo para parar!");
          return;
        }

        fetch(`/stop_timer/${currentTimerId}`)
          .then((response) => response.json())
          .then((data) => {
            if (data.stopped) {
              showStatus("Timer parado com sucesso", "success");
              stopTimerDisplay();
            } else {
              showStatus("Erro ao parar timer", "error");
            }
          })
          .catch((error) => {
            console.error("Erro:", error);
            showStatus("Erro ao parar timer", "error");
          });
      }

      // Atualizar configura√ß√£o quando os valores mudam
      document
        .getElementById("totalTime")
        .addEventListener("input", updateConfigSummary);
      document
        .getElementById("rounds")
        .addEventListener("input", updateConfigSummary);

      // Enter para iniciar timer
      document.addEventListener("keypress", function (event) {
        if (event.key === "Enter") {
          startTimer();
        }
      });

      // Verificar timers ativos ao carregar a p√°gina
      window.addEventListener("load", function () {
        updateConfigSummary();
        fetch("/active_timers")
          .then((response) => response.json())
          .then((data) => {
            if (data.active_count > 0 && data.timers.length > 0) {
              currentTimerId = data.timers[0];
              statusInterval = setInterval(updateTimerDisplay, 100);
              updateTimerDisplay();
              showStatus("Timer anterior detectado - reconectado");
            }
          });
      });
    </script>
  </body>
</html>
